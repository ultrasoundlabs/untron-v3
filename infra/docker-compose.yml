services:
  db:
    image: postgres:18.1
    environment:
      POSTGRES_DB: untron
      POSTGRES_PASSWORD: postgres
      POSTGRES_EXPORTER_PASSWORD: ${POSTGRES_EXPORTER_PASSWORD:?set POSTGRES_EXPORTER_PASSWORD}
      UI_READONLY_PASSWORD: ${UI_READONLY_PASSWORD:?set UI_READONLY_PASSWORD}
      PGRST_AUTH_PASSWORD: ${PGRST_AUTH_PASSWORD:?set PGRST_AUTH_PASSWORD}
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d untron"]
      interval: 2s
      timeout: 5s
      retries: 30
    volumes:
      - db_data:/var/lib/postgresql
      - ../apps/indexer/db/init:/docker-entrypoint-initdb.d:ro

  db_migrate:
    build:
      context: ..
      dockerfile: apps/indexer/Dockerfile
    environment:
      DATABASE_URL: postgres://postgres:postgres@db:5432/untron
    entrypoint: ["/usr/local/bin/migrate"]
    command: ["--no-notify-pgrst"]
    depends_on:
      db:
        condition: service_healthy

  postgres_exporter:
    image: quay.io/prometheuscommunity/postgres-exporter:v0.18.1
    environment:
      DATA_SOURCE_NAME: postgres://postgres_exporter:${POSTGRES_EXPORTER_PASSWORD}@db:5432/untron?sslmode=disable
    expose:
      - "9187"
    depends_on:
      db:
        condition: service_healthy

  otelcol:
    image: otel/opentelemetry-collector-contrib:0.142.0
    command: ["--config=/etc/otelcol/config.yaml"]
    volumes:
      - ./otelcol/config.yaml:/etc/otelcol/config.yaml:ro
    ports:
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
      - "9464:9464" # Prometheus scrape endpoint (/metrics)
    depends_on:
      - postgres_exporter

  pgweb:
    image: sosedoff/pgweb:0.17.0
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8081:8081"
    environment:
      DATABASE_URL: postgres://ui_readonly:${UI_READONLY_PASSWORD}@db:5432/untron?sslmode=disable
    command: ["pgweb", "--bind=0.0.0.0", "--listen=8081"]

  postgrest:
    image: postgrest/postgrest:v14.2
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      db_migrate:
        condition: service_completed_successfully
    expose:
      - "3000"
      - "3001"
    environment:
      PGRST_DB_URI: postgres://pgrst_authenticator:${PGRST_AUTH_PASSWORD}@db:5432/untron
      PGRST_DB_SCHEMAS: api
      PGRST_DB_ANON_ROLE: pgrst_anon
      # Security hardening:
      # - OpenAPI should reflect the effective role privileges (so the UI doesn't advertise writes).
      # - Force a rollback at end of every request as a defense-in-depth read-only guarantee.
      PGRST_OPENAPI_MODE: follow-privileges
      PGRST_DB_TX_END: rollback
      PGRST_ADMIN_SERVER_PORT: 3001
      PGRST_ADMIN_SERVER_HOST: 0.0.0.0

  swagger:
    image: swaggerapi/swagger-ui:v5.31.0
    restart: unless-stopped
    expose:
      - "8080" # we expose swagger through caddy for clean PostgREST+Swagger multi-path
    environment:
      BASE_URL: /docs
      SWAGGER_JSON_URL: /openapi.json
      VALIDATOR_URL: ""
      SUPPORTED_SUBMIT_METHODS: '["get"]'

  openapi_sidecar:
    image: python:3.12-slim
    restart: unless-stopped
    environment:
      UPSTREAM_OPENAPI_URL: http://postgrest:3000/
      CACHE_SECONDS: "30"
    command: >
      sh -c "pip install --no-cache-dir flask requests gunicorn && gunicorn -w 2 -b 0.0.0.0:5000 sidecar:app"
    volumes:
      - ./openapi-sidecar:/sidecar:ro
    working_dir: /sidecar
    expose:
      - "5000"
    depends_on:
      - postgrest

  indexer:
    build:
      context: ..
      dockerfile: apps/indexer/Dockerfile
    restart: unless-stopped
    profiles: ["indexer"]
    env_file:
      - ./indexer.env
    depends_on:
      db_migrate:
        condition: service_completed_successfully
      otelcol:
        condition: service_started
    extra_hosts:
      - "host.docker.internal:host-gateway"

  relayer:
    build:
      context: ..
      dockerfile: apps/relayer/Dockerfile
    restart: unless-stopped
    profiles: ["relayer"]
    env_file:
      - ./relayer.env
    depends_on:
      postgrest:
        condition: service_started
      otelcol:
        condition: service_started
    extra_hosts:
      - "host.docker.internal:host-gateway"

  gateway:
    image: caddy:2.9.1
    restart: unless-stopped
    depends_on:
      - postgrest
      - swagger
    ports:
      - "8080:8080"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro

volumes:
  db_data:
