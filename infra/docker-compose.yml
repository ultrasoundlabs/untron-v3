services:
  db:
    image: postgres:18.1
    environment:
      POSTGRES_DB: untron
      POSTGRES_PASSWORD: postgres
      POSTGRES_EXPORTER_PASSWORD: ${POSTGRES_EXPORTER_PASSWORD:?set POSTGRES_EXPORTER_PASSWORD}
      UI_READONLY_PASSWORD: ${UI_READONLY_PASSWORD:?set UI_READONLY_PASSWORD}
      PGRST_AUTH_PASSWORD: ${PGRST_AUTH_PASSWORD:?set PGRST_AUTH_PASSWORD}
    ports:
      - "5433:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d untron"]
      interval: 2s
      timeout: 5s
      retries: 30
    volumes:
      - db_data:/var/lib/postgresql
      - ../apps/indexer/db/init:/docker-entrypoint-initdb.d:ro

  db_migrate:
    build:
      context: ..
      dockerfile: apps/indexer/Dockerfile
    environment:
      DATABASE_URL: postgres://postgres:postgres@db:5432/untron
    entrypoint: ["/usr/local/bin/migrate"]
    command: ["--no-notify-pgrst"]
    depends_on:
      db:
        condition: service_healthy

  postgres_exporter:
    image: quay.io/prometheuscommunity/postgres-exporter:v0.18.1
    environment:
      DATA_SOURCE_NAME: postgres://postgres_exporter:${POSTGRES_EXPORTER_PASSWORD}@db:5432/untron?sslmode=disable
    expose:
      - "9187"
    depends_on:
      db:
        condition: service_healthy

  otelcol:
    image: otel/opentelemetry-collector-contrib:0.142.0
    command: ["--config=/etc/otelcol/config.yaml"]
    volumes:
      - ./otelcol/config.yaml:/etc/otelcol/config.yaml:ro
    ports:
      - "4317:4317" # OTLP gRPC
      - "4318:4318" # OTLP HTTP
      - "9464:9464" # Prometheus scrape endpoint (/metrics)
    depends_on:
      - postgres_exporter

  pgweb:
    image: sosedoff/pgweb:0.17.0
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8081:8081"
    environment:
      DATABASE_URL: postgres://ui_readonly:${UI_READONLY_PASSWORD}@db:5432/untron?sslmode=disable
    command: ["pgweb", "--bind=0.0.0.0", "--listen=8081"]

  postgrest:
    image: postgrest/postgrest:v14.2
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
      db_migrate:
        condition: service_completed_successfully
    expose:
      - "3000"
      - "3001"
    environment:
      PGRST_DB_URI: postgres://pgrst_authenticator:${PGRST_AUTH_PASSWORD}@db:5432/untron
      PGRST_DB_SCHEMAS: api
      PGRST_DB_ANON_ROLE: pgrst_anon
      # Security hardening:
      # - OpenAPI should reflect the effective role privileges (so the UI doesn't advertise writes).
      # - Force a rollback at end of every request as a defense-in-depth read-only guarantee.
      PGRST_OPENAPI_MODE: follow-privileges
      PGRST_DB_TX_END: rollback
      PGRST_ADMIN_SERVER_PORT: 3001
      PGRST_ADMIN_SERVER_HOST: 0.0.0.0

  scalar:
    image: scalarapi/api-reference:latest
    restart: unless-stopped
    expose:
      - "8080"
    environment:
      # This is Scalar's main config mechanism in the Docker image
      # (you can also mount files into /docs instead)
      API_REFERENCE_CONFIG: >
        {
          "sources": [
            { "url": "/openapi.json", "title": "Untron API", "default": true }
          ]
        }

  openapi_sidecar:
    image: node:20-slim
    restart: unless-stopped
    environment:
      UPSTREAM_OPENAPI_URL: http://postgrest:3000/
      CACHE_SECONDS: "30"
      REALTOR_OPENAPI_URL: http://realtor:3000/openapi.json
    command: ["node", "/sidecar/dist/server.cjs"]
    volumes:
      - ./openapi-sidecar/dist:/sidecar/dist:ro
    expose:
      - "5000"
    healthcheck:
      test:
        [
          "CMD",
          "node",
          "-e",
          "fetch('http://127.0.0.1:5000/healthz').then(r=>process.exit(r.ok?0:1)).catch(()=>process.exit(1))",
        ]
      interval: 2s
      timeout: 2s
      retries: 30
    depends_on:
      - postgrest

  indexer:
    build:
      context: ..
      dockerfile: apps/indexer/Dockerfile
    restart: unless-stopped
    env_file:
      - ./indexer.env
    depends_on:
      db_migrate:
        condition: service_completed_successfully
      otelcol:
        condition: service_started
    extra_hosts:
      - "host.docker.internal:host-gateway"

  relayer:
    build:
      context: ..
      dockerfile: apps/relayer/Dockerfile
    restart: unless-stopped
    profiles: ["relayer"]
    env_file:
      - ./relayer.env
    depends_on:
      postgrest:
        condition: service_started
      indexer:
        condition: service_started
      otelcol:
        condition: service_started
    extra_hosts:
      - "host.docker.internal:host-gateway"

  realtor:
    build:
      context: ..
      dockerfile: apps/realtor/Dockerfile
    restart: unless-stopped
    profiles: ["realtor"]
    env_file:
      - ./realtor.env
    expose:
      - "3000"
    depends_on:
      gateway:
        condition: service_started
      postgrest:
        condition: service_started
      indexer:
        condition: service_started
      otelcol:
        condition: service_started
    extra_hosts:
      - "host.docker.internal:host-gateway"

  gateway:
    image: caddy:2.9.1
    restart: unless-stopped
    depends_on:
      postgrest:
        condition: service_started
      scalar:
        condition: service_started
      openapi_sidecar:
        condition: service_healthy
    ports:
      - "8080:8080"
    volumes:
      - ./caddy/Caddyfile:/etc/caddy/Caddyfile:ro

volumes:
  db_data:
