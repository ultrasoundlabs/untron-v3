%% Untron V3 protocol lifecycle (infographic-ready)
%% Render (local):  npx -y @mermaid-js/mermaid-cli@latest -i docs/untron-v3.mmd -o docs/untron-v3.svg
%% Render (docker): docker run --rm -v "$PWD:/data" ghcr.io/mermaid-js/mermaid-cli/mermaid-cli:latest -i /data/docs/untron-v3.mmd -o /data/docs/untron-v3.svg

flowchart LR
  %% -------------------------------------------------------------------------
  %% LANE: ONE-TIME SETUP / CONFIG
  %% -------------------------------------------------------------------------
  subgraph SETUP["Setup / config (occasionally)"]
    direction TB
    Admin["Owner / Admin"]
    Realtor["Realtor (allowlisted)"]
    LP["LP (allowlisted for deposits)"]

    AdminCfg["EVM Hub config:\n- setUsdt\n- setTronReader\n- setSwapRate\n- setBridger\n- allowlists\n- pause/unpause"]
    Admin --> AdminCfg
  end

  %% -------------------------------------------------------------------------
  %% LANE: TRON SIDE (SOURCE CHAIN)
  %% -------------------------------------------------------------------------
  subgraph TRON["Tron lane (source chain)"]
    direction TB
    Depositor["Depositor / end user"]
    ReceiverAddr["Deterministic receiver address\n(predictable from controller+salt)"]
    TronUSDT["Tron USDT (TRC-20 contract)"]

    TronController["UntronController\n- pullFromReceivers (permissionless)\n- rebalanceUsdt (permissionless)\n- emits event hash-chain tip"]
    Receiver["UntronReceiver (CREATE2)\n- holds tokens\n- only controller can pull()"]
    EventChainTip["Controller eventChainTip (sha256 hash-chain)\nmaintained by UntronControllerIndex"]

    Depositor -->|"TRC-20 transfer(to receiver, amount)"| TronUSDT
    TronUSDT -->|"USDT credited to receiver address"| ReceiverAddr
    ReceiverAddr -. "receiver may not be deployed yet" .-> Receiver

    TronController -->|"deploy receiver if missing (CREATE2)"| Receiver
    TronController -->|"pull(token, amount) from receivers"| Receiver
    TronController -->|"emit PulledFromReceiver + other events\n(advances eventChainTip)"| EventChainTip
  end

  %% -------------------------------------------------------------------------
  %% LANE: EVM HUB (DESTINATION/SETTLEMENT CHAIN)
  %% -------------------------------------------------------------------------
  subgraph EVM["EVM lane (UntronV3 hub)"]
    direction TB

    Hub["UntronV3 hub (facets)\n- LeaseFacet\n- EntitleFacet\n- ControllerFacet\n- FillFacet\n- LpFacet\n(+ AdminFacet)"]

    LeaseTimeline["Lease timeline per receiverSalt\n(active lease by timestamp)\ncreated by createLease (realtor-only)"]
    PayoutCfg["Per-lease payout config\n(targetChainId, targetToken, beneficiary)\nmutable by lessee"]

    ClaimQueues["Claim queues (FIFO) keyed by targetToken\nClaim.amountUsdt is always USDT-denominated"]
    NextIdx["nextIndexByTargetToken[targetToken]\n(head cursor; filled slots deleted)"]

    LPVault["Fast-fill LP vault (principal-only)\n- deposit: allowlisted\n- withdraw: always allowed\nlpPrincipal[lp] tracks principal"]
    HubUSDT["Hub-held USDT balance\n(usdtBalance())"]

    TronReader["tronReader (ITronTxReader)\nverifies Tron tx:\n- finalized block headers\n- inclusion proof\n- success\n- parses TriggerSmartContract"]

    SwapExec["SwapExecutor (per-hub)\nexecutes arbitrary calls\n+ enforces min output"]

    Bridger["IBridger registry\nbridgers[targetToken][targetChainId]"]

    Fill["fill(targetToken, maxClaims, calls)\n- plans batch by available USDT\n- swaps once per targetToken (optional)\n- pays locally or via bridger\n- swap surplus -> filler incentive"]

    %% Lease creation + payout config
    Realtor -->|"createLease(receiverSalt,...)"| Hub
    Hub --> LeaseTimeline
    Hub --> PayoutCfg

    %% LP vault -> available USDT liquidity
    LP -->|"deposit(amount USDT)"| Hub
    Hub --> LPVault
    LPVault --> HubUSDT

    %% Claims are created by either fast or slow recognition paths
    Hub --> ClaimQueues
    ClaimQueues --> NextIdx

    %% Fill uses USDT liquidity + optional swap + optional bridge
    HubUSDT -->|"fill() consumption"| Hub
    Hub --> Fill
    Fill -->|"if targetToken != USDT:\nswap once for batch"| SwapExec
    Fill -->|"local transfer OR bridge"| Bridger
  end

  %% -------------------------------------------------------------------------
  %% FAST PATH: PER-DEPOSIT PROOF -> CLAIM (PERMISSIONLESS)
  %% -------------------------------------------------------------------------
  subgraph FAST["Fast path (permissionless): prove deposit -> claim"]
    direction TB
    PreEntitle["preEntitle(receiverSalt, blocks, tx, proof, index)\n- replay-protected by txId\n- enforces tx calls tronUsdt\n- enforces recipient == predicted receiver\n- attributes to active lease at tx timestamp\n- recognizedRaw += raw\n- unbackedRaw += raw\n- books fees to protocolPnl\n- enqueues claim(netOut) if > 0"]

    PreEntitle --> ClaimQueues
  end

  %% -------------------------------------------------------------------------
  %% OPTIONAL ACCELERATOR: SUBJECTIVE PRE-ENTITLE (LP-SPONSORED)
  %% -------------------------------------------------------------------------
  subgraph SUBJECTIVE["Optional accelerator: LP-sponsored subjective pre-entitle"]
    direction TB
    Subj["subjectivePreEntitle(txId guess, leaseId guess, raw guess)\n- debits sponsor lpPrincipal immediately\n- enqueues normal claim\n- reimburses sponsor if later preEntitle proves exact match"]
    Subj --> ClaimQueues
  end

  %% -------------------------------------------------------------------------
  %% SLOW PATH: CONTROLLER EVENT HASH-CHAIN -> BACKING + CLAIMS (PERMISSIONLESS)
  %% -------------------------------------------------------------------------
  subgraph SLOW["Slow path (permissionless): controller event-chain -> backing + claims"]
    direction TB
    TipTx["Tron tx calls isEventChainTip(tipNew)\n(provable successful tx)"]

    Relay["relayControllerEventChain(blocks, tx, proof, index, events)\n- proves TipTx\n- checks to == controller\n- checks provided events hash-link lastTip->tipNew\n- enqueues raw events"]
    Process["processControllerEvents(max)\n- consumes queued events\n- PulledFromReceiver:\n  - updates lastReceiverPullTimestampByToken\n  - if token==tronUsdt: repays unbackedRaw oldest-first\n  - leftover becomes profit volume\n  - profit volume -> claim under lease active at dumpTimestamp\n- UsdtSet/UsdtRebalanced/ControllerUsdtTransfer update state/PnL"]

    Relay --> Process
    Process --> LeaseTimeline
    Process --> ClaimQueues
  end

  %% -------------------------------------------------------------------------
  %% DESTINATION (OPTIONAL): BRIDGE DELIVERY
  %% -------------------------------------------------------------------------
  subgraph DEST["Destination chain (optional)"]
    direction TB
    Beneficiary["Beneficiary receives\n- local transfer, or\n- bridged delivery"]
  end

  %% -------------------------------------------------------------------------
  %% CROSS-LANE CONNECTIONS
  %% -------------------------------------------------------------------------
  %% Fast path uses tronReader to verify the deposit proof
  PreEntitle -->|"uses"| TronReader
  TronReader -->|"verifies included tx\n+ returns txId,timestamp,to,calldata"| PreEntitle
  TronUSDT -->|"deposit tx is about this contract"| PreEntitle
  ReceiverAddr -->|"recipient must match predicted receiver"| PreEntitle
  LeaseTimeline -->|"active lease at tx timestamp"| PreEntitle

  %% Subjective reconciliation happens inside preEntitle (if a subjective record exists for txId)
  Subj -. "later: preEntitle reimburses sponsor if exact match" .-> PreEntitle

  %% Slow path uses tronReader to prove the isEventChainTip call happened on Tron
  TipTx -->|"proved by"| TronReader
  TronReader --> Relay
  EventChainTip -->|"tipNew equals controller state\nat proved block"| Relay

  %% Filling settles to beneficiary (directly or via bridger)
  Bridger --> Beneficiary
  Hub -->|"if targetChainId == chainid:\ntransfer(targetToken, beneficiary)"| Beneficiary

  %% -------------------------------------------------------------------------
  %% STYLING (lightweight)
  %% -------------------------------------------------------------------------
  classDef perm fill:#E8FFF0,stroke:#0E7A39,stroke-width:1px,color:#0E7A39;
  classDef permOnly fill:#FFF3E0,stroke:#B26A00,stroke-width:1px,color:#7A3F00;
  classDef core fill:#EEF5FF,stroke:#2B62D6,stroke-width:1px,color:#133B8A;
  classDef data fill:#F3F4F6,stroke:#6B7280,stroke-width:1px,color:#111827;

  class PreEntitle,Relay,Process perm;
  class TronController perm;
  class Fill perm;

  class Realtor,LP,Admin permOnly;
  class Hub,SwapExec,TronReader core;
  class LeaseTimeline,PayoutCfg,ClaimQueues,EventChainTip,HubUSDT,LPVault,NextIdx data;
